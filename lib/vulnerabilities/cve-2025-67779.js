/**
 * CVE-2025-67779: Denial of Service with Server Components - Incomplete Fix Follow-Up
 * @see https://github.com/advisories/GHSA-5j59-xgg2-r9c4
 * @see https://www.cve.org/CVERecord?id=CVE-2025-67779
 *
 *
 * Affected versions:
 * - Next.js 13.x (>= 13.3) - upgrade to 14.2.35
 * - Next.js 14.x before 14.2.35
 * - Next.js 15.0.x before 15.0.7
 * - Next.js 15.1.x before 15.1.11
 * - Next.js 15.2.x before 15.2.8
 * - Next.js 15.3.x before 15.3.8
 * - Next.js 15.4.x before 15.4.10
 * - Next.js 15.5.x before 15.5.9
 * - Next.js 15.x canary before 15.6.0-canary.60
 * - Next.js 16.0.x before 16.0.10
 * - Next.js 16.x canary before 16.1.0-canary.19
 *
 * Note: Next.js Pages Router applications are not affected.
 */

const { parseVersion, compareVersions } = require('../utils/version');

// Patched versions for Next.js 15.x and 16.x stable releases
const NEXT_PATCHED_VERSIONS = {
  '15.0': '15.0.7',
  '15.1': '15.1.11',
  '15.2': '15.2.8',
  '15.3': '15.3.8',
  '15.4': '15.4.10',
  '15.5': '15.5.9',
  '16.0': '16.0.10',
};

// Patched canary versions
const NEXT_CANARY_PATCHES = {
  15: '15.6.0-canary.60',
  16: '16.1.0-canary.19',
};

function isNextVulnerable(version) {
  const parsed = parseVersion(version);
  if (!parsed) return { vulnerable: false, reason: 'unparseable' };

  const { major, minor, raw, isCanary } = parsed;

  // Versions before 13.3 are not affected (App Router introduced in 13.3)
  if (major < 13) {
    return { vulnerable: false, reason: 'version-too-old' };
  }

  if (major === 13) {
    // 13.x >= 13.3 is vulnerable, must upgrade to 14.2.35
    if (minor >= 3) {
      return { vulnerable: true, reason: '13.x-app-router' };
    }
    return { vulnerable: false, reason: 'before-app-router' };
  }

  // Next.js 14.x
  if (major === 14) {
    // All 14.x canaries are vulnerable (no patch available)
    if (isCanary) {
      return { vulnerable: true, reason: '14.x-canary-no-patch' };
    }

    // Stable 14.x - all versions before 14.2.35 are vulnerable
    if (compareVersions(raw, '14.2.35') < 0) {
      return { vulnerable: true, reason: 'below-14.2.35' };
    }
    return { vulnerable: false, reason: 'patched' };
  }

  // Next.js 15.x
  if (major === 15) {
    if (isCanary) {
      if (compareVersions(raw, '15.6.0-canary.60') >= 0) {
        return { vulnerable: false, reason: 'patched-canary' };
      }
      return { vulnerable: true, reason: '15.x-canary' };
    }

    const minorKey = `${major}.${minor}`;
    const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

    if (!patchedVersion) {
      return { vulnerable: minor < 6, reason: minor < 6 ? 'unknown-minor-assume-vulnerable' : 'unknown-minor-assume-safe' };
    }

    if (compareVersions(raw, patchedVersion) < 0) {
      return { vulnerable: true, reason: `below-${patchedVersion}` };
    }
    return { vulnerable: false, reason: 'patched' };
  }

  // Next.js 16.x
  if (major === 16) {
    if (isCanary) {
      if (compareVersions(raw, '16.1.0-canary.19') >= 0) {
        return { vulnerable: false, reason: 'patched-canary' };
      }
      return { vulnerable: true, reason: '16.x-canary' };
    }

    const minorKey = `${major}.${minor}`;
    const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

    if (patchedVersion && compareVersions(raw, patchedVersion) < 0) {
      return { vulnerable: true, reason: `below-${patchedVersion}` };
    }

    if (minor >= 1) {
      return { vulnerable: false, reason: 'patched' };
    }

    if (minor === 0 && parsed.patch < 10) {
      return { vulnerable: true, reason: 'below-16.0.10' };
    }

    return { vulnerable: false, reason: 'patched' };
  }

  // Future versions (17+) - assume safe
  return { vulnerable: false, reason: 'future-version' };
}

function getNextPatchedVersion(version) {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  const { major, minor, isCanary } = parsed;

  // Versions before 13.3 are not affected
  if (major < 13) return null;

  // 13.x must upgrade to 14.2.35
  if (major === 13) {
    return {
      recommended: '14.2.35',
      note: 'Next.js 13.x must upgrade to 14.2.35 or later to fix this vulnerability.',
    };
  }

  // 14.x canary - no patch available, must upgrade to 15.x or 14.2.35 stable
  if (major === 14 && isCanary) {
    return {
      recommended: '14.2.35',
      alternative: '15.0.7',
      note: 'No 14.x canary patch available. Upgrade to 14.2.35 stable or 15.0.7.',
    };
  }

  // 14.x stable
  if (major === 14) {
    return { recommended: '14.2.35' };
  }

  // 15.x/16.x canary versions
  if (isCanary) {
    const canaryPatch = NEXT_CANARY_PATCHES[major];
    if (canaryPatch) {
      return { recommended: canaryPatch };
    }
  }

  // 15.x/16.x stable versions
  const minorKey = `${major}.${minor}`;
  const patchedVersion = NEXT_PATCHED_VERSIONS[minorKey];

  if (patchedVersion) {
    return { recommended: patchedVersion };
  }

  // Fallback for unknown minors
  if (major === 15) return { recommended: '15.5.9' };
  if (major === 16) return { recommended: '16.0.10' };

  return null;
}

module.exports = {
  id: 'CVE-2025-67779',
  name: 'DoS Incomplete Fix Follow-Up',
  severity: 'high',
  description: 'Incomplete fix for CVE-2025-55184 DoS via malicious RSC payload causing infinite loop',
  packages: ['next'],

  isVulnerable(packageName, version) {
    if (packageName === 'next') {
      return isNextVulnerable(version);
    }
    return { vulnerable: false, reason: 'not-applicable' };
  },

  getPatchedVersion(packageName, version) {
    if (packageName === 'next') {
      return getNextPatchedVersion(version);
    }
    return null;
  },
};

